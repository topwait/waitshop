{extend name="public/layout" /}

{block name="body"}
<div class="container">
    <div class="layui-card">

        <!-- 搜索栏 -->
        <div class="layui-card-body" style="padding: 20px 15px 0;">
            <form class="layui-form">
                <div class="layui-form-item" style="margin-bottom: 5px;">
                    <div class="layui-inline">
                        <label for="category" class="layui-form-label">商品分类：</label>
                        <div class="layui-input-inline">
                            <select id="category" name="category" class="layui-input layui-unselect" style="width:200px;">
                                <option value="" selected>全部</option>
                                {volist name="$treeCategory" id="vo"}
                                <option value="{$vo.id}">{$vo.html} {$vo.name}</option>
                                {/volist}
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label for="name" class="layui-form-label">商品名称：</label>
                        <div class="layui-input-inline">
                            <input type="text" id="name" name="name" class="layui-input" placeholder="请输入商品名称">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <a class="layui-btn layui-btn-sm" lay-submit lay-filter="search">查询</a>
                        <a class="layui-btn layui-btn-sm layui-btn-primary" lay-submit lay-filter="clear-search">清空查询</a>
                    </div>
                </div>
            </form>
        </div>

        <!-- 内容栏 -->
        <div class="layui-card-body wait-table-cell">
            <table id="wait-table-lists" lay-filter="wait-table-lists"></table>
            <script type="text/html" id="toolbar">
                <div class="layui-btn-container">
                    <button class="layui-btn layui-btn-sm" lay-event="add">新增分销商品</button>
                </div>
            </script>
            <script type="text/html" id="table-image">
                <img src="{{d.image}}" alt="img" style="width:60px; height:60px;">
            </script>
            <script type="text/html" id="table-name">
                <p class="wait-line-3" style="line-height:19px;">{{d.name}}</p>
            </script>
            <script type="text/html" id="operate">
                <button type="button" class="layui-btn layui-btn-xs" lay-event="edit">设置佣金</button>
                <button type="button" class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del">移除分销</button>
            </script>
        </div>
    </div>
</div>
{/block}

{block name="js"}
<script>
    layui.use(["table", "form"], function() {
        let table = layui.table;
        let form = layui.form;

        // 渲染表格
        wait.table({
            elem: "#wait-table-lists"
            ,url: "{:url('addons.distribution.DistributionGoods/lists')}"
            ,cols: [[
                {field:"id", title:"ID", width:50, align:"center"},
                {field:"image", title:"商品图片", width:100, align:"center", templet:"#table-image"},
                {field:"name", title:"商品名称", width:200, templet:"#table-name"},
                {field:"original_price", title:"商品售价", width:130, align:"center"},
                {field:"sales_volume", title:"销量", width:80, align:"center"},
                {fixed:"right", title:"操作", toolbar:"#operate", width:170, align:"center"},
            ]]
        });

        // 绑定事件
        wait.BindEvents({
            add: function () {
                layer.open({
                    type: 2
                    ,title: "选择商品"
                    ,area: ["850px", "600px"]
                    ,offset: "auto"
                    ,anim: 1
                    ,closeBtn: 1
                    ,shade: 0.3
                    ,btn: ["确定", "取消"]
                    ,content: "/admin/data/goods?type=radio"
                    ,yes: function (indexWin, layeroWin) {
                        let iframeWin = window[layeroWin.find("iframe")[0]["name"]];
                        let data = iframeWin.getSelectedData();
                        let goods_id = data[0]["id"];
                        layer.close(indexWin);
                        wait.popup({
                            title: "新增分销商品",
                            url: "{:url('addons.distribution.DistributionGoods/add')}?goods_id=" + goods_id,
                            area: ["95%", "95%"],
                            success: function (layero, index, elem) {
                                layero.layui.form.on("submit(addForm)", function(data){
                                    let goodsSku = [];
                                    $(elem).find("#sku-lists-table tr.on").each(function () {
                                        if (!$(this).find("input[name='first_ratio']").val()) {
                                            return layer.msg('勾选的规格里存在未填写的一级比例');
                                        }
                                        if (!$(this).find("input[name='second_ratio']").val()) {
                                            return layer.msg('勾选的规格里存在未填写的二级比例');
                                        }
                                        goodsSku.push({
                                            "sku_id": $(this).find("input[name='sku_id']").val(),
                                            "first_ratio": $(this).find("input[name='first_ratio']").val(),
                                            "second_ratio": $(this).find("input[name='second_ratio']").val(),
                                        });
                                    });

                                    if (goodsSku.length <= 0) {
                                        layer.msg('请选择参与分销的商品规格');
                                        return false;
                                    }

                                    data.field['sku'] = goodsSku;
                                    wait.ajax({
                                        url: "{:url('addons.distribution.DistributionGoods/add')}",
                                        type: "POST",
                                        data: data.field
                                    }).then((res) => {
                                        if (res.code === 0) {
                                            layer.msg(res.msg, {icon: 1, time: 1000});
                                            table.reload("wait-table-lists", {
                                                where: [],
                                                page: { curr: 1 }
                                            });
                                            layer.close(index);
                                        }
                                    });
                                });
                            }
                        });

                    }
                });
            },
            edit: function (obj) {
                wait.popup({
                    title: "编辑拼团活动",
                    url: "{:url('addons.distribution.DistributionGoods/edit')}?id=" + obj.data.id,
                    area: ["95%", "95%"],
                    success: function (layero, index, elem) {
                        layero.layui.form.on("submit(addForm)", function(data){
                            let goodsSku = [];
                            $(elem).find("#sku-lists-table tr.on").each(function () {
                                if (!$(this).find("input[name='first_ratio']").val()) {
                                    return layer.msg('勾选的规格里存在未填写的一级比例');
                                }
                                if (!$(this).find("input[name='second_ratio']").val()) {
                                    return layer.msg('勾选的规格里存在未填写的二级比例');
                                }
                                goodsSku.push({
                                    "sku_id": $(this).find("input[name='sku_id']").val(),
                                    "dis_sku_id": $(this).find("input[name='dis_sku_id']").val(),
                                    "first_ratio": $(this).find("input[name='first_ratio']").val(),
                                    "second_ratio": $(this).find("input[name='second_ratio']").val(),
                                });
                            });

                            if (goodsSku.length <= 0) {
                                layer.msg('请选择参与分销的商品规格');
                                return false;
                            }

                            data.field['id'] = obj.data.id;
                            data.field['sku'] = goodsSku;
                            wait.ajax({
                                url: "{:url('addons.distribution.DistributionGoods/edit')}",
                                type: "POST",
                                data: data.field
                            }).then((res) => {
                                if (res.code === 0) {
                                    layer.msg(res.msg, {icon: 1, time: 1000});
                                    table.reload("wait-table-lists", {
                                        where: []
                                    });
                                }
                                layer.close(index);
                            });
                        });
                    }
                });
            },
            del: function (obj) {
                layer.confirm("确定要删除此分销商品吗?", function(index) {
                    wait.ajax({
                        url: "{:url('addons.distribution.DistributionGoods/del')}",
                        type: "POST",
                        data: {id: obj.data.id}
                    }).then((res) => {
                        if (res.code === 0) {
                            layer.msg(res.msg, {icon: 1, time: 1000});
                            table.reload("wait-table-lists", {
                                where: []
                            });
                        }
                    });
                    layer.close(index);
                });
            }
        });

        // 监听搜索
        form.on("submit(search)", function(data) {
            table.reload("wait-table-lists", {
                where: data.field,
                page: { curr: 1 }
            });
        });

        // 清空搜索
        form.on("submit(clear-search)", function() {
            $("#name").val("");
            table.reload("wait-table-lists", {
                where: [],
                page: { curr: 1 }
            });
        });

    });
</script>
{/block}